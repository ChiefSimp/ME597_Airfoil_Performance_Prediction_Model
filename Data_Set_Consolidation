# build_dataset.py

import pandas as pd

from data_acquisition import (
    fetch_airfoil_coords,
    discover_polar_ids_for_airfoil,
    fetch_polar_table,
)
from feature_engineering import (
    compute_geom_features_from_coords,
    compute_cl_alpha_linear_fit,
    compute_stall_angle,
)


def build_dataset_for_airfoils(airfoil_ids, max_polars_per_airfoil=1) -> pd.DataFrame:
    """
    For each airfoil:
      - fetch coordinates and compute geometric features
      - discover available polars (up to max_polars_per_airfoil)
      - compute Cl-alpha slope and stall angle for each polar

    Returns:
      DataFrame where each row corresponds to (airfoil_id, polar_id).
    """
    records = []

    for airfoil_id in airfoil_ids:
        print(f"Processing airfoil: {airfoil_id}")

        try:
            coords_df = fetch_airfoil_coords(airfoil_id)
            geom_feats = compute_geom_features_from_coords(coords_df)
        except Exception as e:
            print(f"  [WARN] Failed coords/geometric features for {airfoil_id}: {e}")
            continue

        try:
            polar_ids = discover_polar_ids_for_airfoil(airfoil_id)
        except Exception as e:
            print(f"  [WARN] Failed discovering polars for {airfoil_id}: {e}")
            continue

        if not polar_ids:
            print(f"  [WARN] No polars found for {airfoil_id}")
            continue

        polar_ids = polar_ids[:max_polars_per_airfoil]

        for polar_id in polar_ids:
            print(f"    Polar: {polar_id}")
            try:
                polar_df = fetch_polar_table(polar_id)
                slope, intercept, lin_r2 = compute_cl_alpha_linear_fit(polar_df)
                stall_alpha = compute_stall_angle(polar_df)
            except Exception as e:
                print(f"    [WARN] Failed polar processing for {polar_id}: {e}")
                continue

            record = {
                "airfoil_id": airfoil_id,
                "polar_id": polar_id,
                "cl_alpha_slope": slope,
                "cl_alpha_intercept": intercept,
                "cl_alpha_r2": lin_r2,
                "stall_alpha_deg": stall_alpha,
            }
            record.update(geom_feats)
            records.append(record)

    return pd.DataFrame(records)


if __name__ == "__main__":
    # Quick manual test
    EXAMPLE_AIRFOILS = [
        "naca2412-il",
        "naca4412-il",
        "naca0012-il",
    ]

    df = build_dataset_for_airfoils(EXAMPLE_AIRFOILS, max_polars_per_airfoil=1)
    print(df.head())
    df.to_csv("airfoil_stall_dataset.csv", index=False)
