import pandas as pd

# Define the URL for the GitHub dataset
github_url = 'https://raw.githubusercontent.com/ChiefSimp/ME597_Airfoil_Performance_Prediction_Model/refs/heads/main/airfoil_dataset_all_airfoils.csv'

# Define the local file path for the local dataset
local_file_path = '/content/airfoil_dataset_all_airfoils.csv'

# Load the GitHub dataset into df_airfoil_geometry
df_airfoil_geometry = pd.read_csv(github_url)

# Remove specified columns from df_airfoil_geometry
columns_to_drop = ['max_cl', 'alpha_at_max_cl', 'cl_alpha_slope']
df_airfoil_geometry = df_airfoil_geometry.drop(columns=columns_to_drop, errors='ignore')

# Load the local dataset into df_airfoil_stall_angle
df_airfoil_stall_angle = pd.read_csv(local_file_path)

print("First 5 rows of 'df_airfoil_geometry' (from GitHub):")
print(df_airfoil_geometry.head())
print("\nShape of 'df_airfoil_geometry':", df_airfoil_geometry.shape)

print("\nFirst 5 rows of 'df_airfoil_stall_angle' (from local file):")
print(df_airfoil_stall_angle.head())
print("\nShape of 'df_airfoil_stall_angle':", df_airfoil_stall_angle.shape)

# Filter df_airfoil_geometry
rows_before_n5_filter_geometry = len(df_airfoil_geometry)
df_airfoil_geometry_filtered = df_airfoil_geometry[~df_airfoil_geometry['polar_id'].str.contains('n5', na=False)]
rows_after_n5_filter_geometry = len(df_airfoil_geometry_filtered)

# Filter df_airfoil_stall_angle
rows_before_n5_filter_stall = len(df_airfoil_stall_angle)
df_airfoil_stall_angle_filtered = df_airfoil_stall_angle[~df_airfoil_stall_angle['polar_id'].str.contains('n5', na=False)]
rows_after_n5_filter_stall = len(df_airfoil_stall_angle_filtered)

print(f"Rows in df_airfoil_geometry before 'n5' filter: {rows_before_n5_filter_geometry}")
print(f"Rows in df_airfoil_geometry after 'n5' filter: {rows_after_n5_filter_geometry}")
print(f"Rows removed from df_airfoil_geometry due to 'n5' polar ID: {rows_before_n5_filter_geometry - rows_after_n5_filter_geometry}")

print(f"\nRows in df_airfoil_stall_angle before 'n5' filter: {rows_before_n5_filter_stall}")
print(f"Rows in df_airfoil_stall_angle after 'n5' filter: {rows_after_n5_filter_stall}")
print(f"Rows removed from df_airfoil_stall_angle due to 'n5' polar ID: {rows_before_n5_filter_stall - rows_after_n5_filter_stall}")

print("\nHead of df_airfoil_geometry_filtered:")
print(df_airfoil_geometry_filtered.head())
print("\nHead of df_airfoil_stall_angle_filtered:")
print(df_airfoil_stall_angle_filtered.head())

common_cols_for_merge = ['airfoil_id', 'polar_id', 'Re']

# Perform the merge
df_airfoil_geometry_and_stall_data = pd.merge(
    df_geometry_final_filtered,
    df_calculated_stall_data,
    on=common_cols_for_merge,
    how='inner'
)

print("Head of the final combined DataFrame ('df_airfoil_geometry_and_stall_data'):")
print(df_airfoil_geometry_and_stall_data.head())

print("\nShape of 'df_airfoil_geometry_and_stall_data':", df_airfoil_geometry_and_stall_data.shape)

# 1. Identify Re values that appear less than 10 times in df_geometry_filtered_by_id
#    Deriving from df_geometry_filtered_by_id ensures consistency with previous filters
re_counts_geometry = df_geometry_filtered_by_id['Re'].value_counts()
re_to_exclude_geometry = re_counts_geometry[re_counts_geometry < 10].index.tolist()

print("Total occurrences for each Reynolds number in df_geometry_filtered_by_id (before Re filter):")
print(re_counts_geometry)

print(f"\nNumber of Re values to exclude (count < 10, from geometry data): {len(re_to_exclude_geometry)}")
print("Infrequent Reynolds numbers to exclude (from geometry data):")
print(re_to_exclude_geometry)

# 2. Filter df_geometry_filtered_by_id
rows_before_re_filter_geometry = len(df_geometry_filtered_by_id)
df_geometry_final_filtered = df_geometry_filtered_by_id[~df_geometry_filtered_by_id['Re'].isin(re_to_exclude_geometry)].copy()
rows_removed_re_geometry = rows_before_re_filter_geometry - len(df_geometry_final_filtered)

print(f"\nRows in geometry dataset before Re filter: {rows_before_re_filter_geometry}")
print(f"Rows in geometry dataset after Re filter: {len(df_geometry_final_filtered)}")
print(f"Rows removed from geometry dataset due to infrequent Re: {rows_removed_re_geometry}")

# 3. Filter df_stall_filtered_by_geometry_id_removal
rows_before_re_filter_stall = len(df_stall_filtered_by_geometry_id_removal)
df_stall_final_filtered = df_stall_filtered_by_geometry_id_removal[~df_stall_filtered_by_geometry_id_removal['Re'].isin(re_to_exclude_geometry)].copy()
rows_removed_re_stall = rows_before_re_filter_stall - len(df_stall_final_filtered)

print(f"\nRows in stall dataset before Re filter: {rows_before_re_filter_stall}")
print(f"Rows in stall dataset after Re filter: {len(df_stall_final_filtered)}")
print(f"Rows removed from stall dataset due to infrequent Re: {rows_removed_re_stall}")

print("\nHead of df_geometry_final_filtered:")
print(df_geometry_final_filtered.head())
print("\nHead of df_stall_final_filtered:")
print(df_stall_final_filtered.head())

import numpy as np
import pandas as pd # Ensure pandas is imported

def calculate_stall_angle_dynamic_max_cl(group, percentage_drop=0.05):
    group = group.sort_values(by='alpha').reset_index(drop=True)
    stall_angle = 'not reached'
    cl_at_stall = np.nan

    max_cl_observed_so_far = -np.inf # Initialize with a very small number

    for i in range(len(group)):
        current_cl = group.loc[i, 'cl']
        current_alpha = group.loc[i, 'alpha']

        # Update max CL observed so far in the sequential scan
        if current_cl > max_cl_observed_so_far:
            max_cl_observed_so_far = current_cl

        # Check for a drop of 'percentage_drop' from the highest CL observed so far
        if current_cl < max_cl_observed_so_far * (1 - percentage_drop):
            # Stall detected: record the alpha and cl of the current row
            stall_angle = current_alpha
            cl_at_stall = current_cl
            break # Found the first stall point, exit loop

    return pd.Series({
        'airfoil_id': group['airfoil_id'].iloc[0],
        'polar_id': group['polar_id'].iloc[0],
        'Re': group['Re'].iloc[0],
        'stall_angle': stall_angle,
        'cl_at_stall': cl_at_stall
    })

# Apply the function to calculate stall data using explicit iteration to avoid DeprecationWarning
results = []
for _, group in df_stall_final_filtered.groupby(['airfoil_id', 'polar_id', 'Re']):
    results.append(calculate_stall_angle_dynamic_max_cl(group))
df_calculated_stall_data = pd.DataFrame(results)

print("\nFirst 10 rows of the calculated stall data ('df_calculated_stall_data'):")
print(df_calculated_stall_data.head(10))

# Calculate the number of 'not reached' airfoils
not_reached_count = df_calculated_stall_data[df_calculated_stall_data['stall_angle'] == 'not reached'].shape[0]

# Get the total number of rows
total_rows_in_dataset = df_calculated_stall_data.shape[0]

# Calculate the number of airfoils where a stall angle was found
stalled_count = total_rows_in_dataset - not_reached_count

print(f"\nTotal number of 'not reached' airfoils: {not_reached_count}")
print(f"Total number of airfoils where a stall angle was found: {stalled_count}")
print(f"Total number of rows in the dataset: {total_rows_in_dataset}")

common_cols_for_merge = ['airfoil_id', 'polar_id', 'Re']

# Perform the merge
df_final_combined = pd.merge(
    df_geometry_final_filtered,
    df_calculated_stall_data,
    on=common_cols_for_merge,
    how='inner'
)

print("Head of the final combined DataFrame ('df_final_combined'):")
print(df_final_combined.head())

print("\nShape of 'df_final_combined':", df_final_combined.shape)

df_mean_thickness = df_final_combined.groupby('airfoil_id')['max_thickness'].mean().reset_index()

print("Head of df_mean_thickness:")
print(df_mean_thickness.head())

min_thickness = df_mean_thickness['max_thickness'].min()
max_thickness = df_mean_thickness['max_thickness'].max()

print(f"Minimum max_thickness: {min_thickness}")
print(f"Maximum max_thickness: {max_thickness}")

df_ratings = df_mean_thickness.copy()

df_ratings['sharpness_rating'] = 100 * (1 - (df_ratings['max_thickness'] - min_thickness) / (max_thickness - min_thickness))
df_ratings['radius_rating'] = 100 * ((df_ratings['max_thickness'] - min_thickness) / (max_thickness - min_thickness))

print("Head of df_ratings with sharpness and radius ratings:")
print(df_ratings.head())

df_final_combined = pd.merge(
    df_final_combined,
    df_ratings[['airfoil_id', 'sharpness_rating', 'radius_rating']],
    on='airfoil_id',
    how='left'
)

print("Head of the updated df_final_combined with sharpness and radius ratings:")
print(df_final_combined.head())

output_filename = 'airfoil_geometry_and_stall_data.csv'
df_final_combined.to_csv(output_filename, index=False)

print(f"Updated df_final_combined with sharpness and radius ratings successfully saved to: '{output_filename}'")
